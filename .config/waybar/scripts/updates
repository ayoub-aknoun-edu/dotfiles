#!/usr/bin/env bash
# Waybar updates module (pacman + optional AUR)
# Dependencies: pacman-contrib (checkupdates), optional yay/paru, notify-send

set -euo pipefail

PACMAN_LOCK="/var/lib/pacman/db.lck"
CHECKUP_LOCK="${TMPDIR:-/tmp}/checkup-db-${UID}/db.lck"

if [[ -f "$PACMAN_LOCK" || -f "$CHECKUP_LOCK" ]]; then
  echo '{"tooltip":"Database locked - try again later","class":"transparent"}'
  exit 0
fi

if ! command -v checkupdates >/dev/null 2>&1; then
  echo '{"tooltip":"checkupdates not found (install pacman-contrib)","class":"transparent"}'
  exit 0
fi

pacman_raw="$(checkupdates 2>/dev/null || true)"
pacman_count="$(printf '%s\n' "$pacman_raw" | sed '/^$/d' | wc -l)"

aur_raw=""
if command -v yay >/dev/null 2>&1; then
  aur_raw="$(yay -Qua 2>/dev/null || true)"
elif command -v paru >/dev/null 2>&1; then
  aur_raw="$(paru -Qua 2>/dev/null || true)"
fi
aur_count="$(printf '%s\n' "$aur_raw" | sed '/^$/d' | wc -l)"

updates=$((pacman_count + aur_count))

class="transparent"
if (( updates > 0 && updates <= 25 )); then
  class="green"
elif (( updates > 25 && updates <= 100 )); then
  class="yellow"
elif (( updates > 100 )); then
  class="red"
fi

if (( updates > 0 )); then
  printf '{"text":"%d","tooltip":"%d updates available\\nPacman: %d\\nAUR: %d","class":"%s"}\n' \
    "$updates" "$updates" "$pacman_count" "$aur_count" "$class"
else
  echo '{"text":"0","tooltip":"System is up to date","class":"transparent"}'
fi
